<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Wisconsin Dales ‚Äî Splash Quiz</title>

  <link rel="manifest" href="/punzone/manifest.json" />
  <meta name="theme-color" content="#D81B60" />

  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    html { font-size: 18px; }
    @media (min-width: 768px) { html { font-size: 16px; } }

    body {
      overscroll-behavior: none;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }

    .bg-dales {
      background:
        radial-gradient(1200px circle at 10% 15%, rgba(255,255,255,0.14), transparent 45%),
        radial-gradient(900px circle at 90% 10%, rgba(255,121,169,0.25), transparent 50%),
        radial-gradient(1200px circle at 50% 105%, rgba(255,192,203,0.16), transparent 55%),
        linear-gradient(180deg, #2b0013 0%, #120611 45%, #0b0b0b 100%);
    }

    .card-glow { box-shadow: 0 20px 70px rgba(216,27,96,0.25); }

    .shake { animation: shake 260ms ease-in-out; }
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-6px); }
      75% { transform: translateX(6px); }
    }

    .pop { animation: pop 180ms ease-out; }
    @keyframes pop {
      0% { transform: scale(1); }
      60% { transform: scale(1.02); }
      100% { transform: scale(1); }
    }

    .confetti {
      position: fixed;
      inset: 0;
      pointer-events: none;
      overflow: hidden;
      z-index: 9999;
    }
    .confetti span {
      position: absolute;
      width: 8px;
      height: 14px;
      border-radius: 2px;
      transform: translateY(-20px) rotate(0deg);
      animation: fall 850ms ease-out forwards;
      opacity: 0.95;
    }
    @keyframes fall {
      to { transform: translateY(110vh) rotate(360deg); opacity: 1; }
    }

    @media (prefers-reduced-motion: reduce) {
      .shake, .pop { animation: none; }
    }
  </style>
</head>

<body class="min-h-screen bg-dales text-white">
  <div class="confetti" id="confetti"></div>

  <!-- Top HUD -->
  <header class="sticky top-0 z-40 backdrop-blur bg-black/25 border-b border-white/10">
    <div class="max-w-xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-2xl bg-white/10 border border-white/15 grid place-items-center">
          <span class="text-xl">üí¶</span>
        </div>
        <div class="leading-tight">
          <div class="font-black tracking-tight">Splash Quiz</div>
          <div class="text-xs text-white/70">Wisconsin Dales ‚Ä¢ Dad Joke Edition</div>
        </div>
      </div>

      <div class="flex items-center gap-2">
        <a href="/" class="text-sm px-3 py-2 rounded-xl bg-white/10 hover:bg-white/15 border border-white/10">
          Back
        </a>
      </div>
    </div>
  </header>

  <main class="max-w-xl mx-auto px-4 py-5 pb-10">
    <!-- Wave Timer -->
    <section class="mt-3">
      <div class="flex items-center justify-between text-xs text-white/70 mb-2">
        <div id="waveLabel">Wave incoming‚Ä¶</div>
        <div class="tabular-nums">
          Q <span id="qNum">0</span>/<span id="qTotal">10</span>
        </div>
      </div>
      <div class="h-3 rounded-full bg-white/10 border border-white/10 overflow-hidden">
        <div id="waveBar" class="h-full w-full bg-[#D81B60]"></div>
      </div>
    </section>

    <!-- Score row -->
    <section class="mt-4 grid grid-cols-3 gap-3">
      <div class="rounded-2xl bg-black/25 border border-white/10 p-3 text-center">
        <div class="text-xs text-white/60">Score</div>
        <div class="text-2xl font-black tabular-nums" id="score">0</div>
      </div>
      <div class="rounded-2xl bg-black/25 border border-white/10 p-3 text-center">
        <div class="text-xs text-white/60">Streak</div>
        <div class="text-2xl font-black tabular-nums" id="streak">0</div>
      </div>
      <div class="rounded-2xl bg-black/25 border border-white/10 p-3 text-center">
        <div class="text-xs text-white/60">High</div>
        <div class="text-2xl font-black tabular-nums" id="high">0</div>
      </div>
    </section>

    <!-- Settings row -->
    <section class="mt-4 grid grid-cols-3 gap-3">
      <button id="modeRound"
        class="rounded-2xl bg-white/10 hover:bg-white/15 border border-white/10 p-3 text-left">
        <div class="text-xs text-white/60">Mode</div>
        <div class="font-black" id="modeText">Round</div>
        <div class="text-xs text-white/60 mt-1" id="modeSub">10 questions</div>
      </button>

      <button id="difficultyBtn"
        class="rounded-2xl bg-white/10 hover:bg-white/15 border border-white/10 p-3 text-left">
        <div class="text-xs text-white/60">Difficulty</div>
        <div class="font-black" id="diffText">Easy</div>
        <div class="text-xs text-white/60 mt-1" id="diffSub">Chill groans</div>
      </button>

      <button id="soundBtn"
        class="rounded-2xl bg-white/10 hover:bg-white/15 border border-white/10 p-3 text-left">
        <div class="text-xs text-white/60">Sound</div>
        <div class="font-black" id="soundText">On</div>
        <div class="text-xs text-white/60 mt-1" id="soundSub">Splash FX</div>
      </button>
    </section>

    <!-- Game Card -->
    <section id="card" class="mt-4 rounded-3xl bg-white/5 border border-white/10 p-5 card-glow">
      <!-- Start Screen -->
      <div id="startScreen" class="text-center">
        <div class="text-3xl font-black tracking-tight">Enter the Splash Quiz üí¶</div>
        <p class="text-white/75 mt-2" id="startDesc">
          10 dad jokes. 3 choices. Beat the wave timer.
        </p>

        <div class="mt-4 rounded-2xl bg-black/25 border border-white/10 p-4 text-left">
          <div class="text-sm font-bold">How it works</div>
          <ul class="text-sm text-white/75 mt-2 space-y-1 list-disc list-inside">
            <li>Pick the correct punchline before the wave hits.</li>
            <li>Correct = points. Wrong/timeout = streak resets.</li>
            <li>Streak bonus every 3 correct answers üî•</li>
          </ul>
        </div>

        <button id="startBtn"
          class="mt-5 w-full py-4 rounded-2xl bg-[#D81B60] hover:opacity-90 font-black text-lg shadow-lg">
          Start Round
        </button>

        <div class="mt-4 text-xs text-white/60" id="loadStatus">Loading jokes‚Ä¶</div>
      </div>

      <!-- Play Screen -->
      <div id="playScreen" class="hidden">
        <div class="flex items-center justify-between text-xs text-white/70">
          <div id="status">Pick the right punchline.</div>
          <div class="tabular-nums" id="seconds">5.0s</div>
        </div>

        <div id="jokeBox"
          class="mt-3 rounded-3xl bg-black/30 border border-white/10 p-5">
          <div class="text-sm text-white/60">Dad says:</div>
          <div id="question" class="mt-1 text-2xl font-black leading-snug">‚Ä¶</div>
        </div>

        <div class="mt-4 grid gap-3">
          <button class="choice w-full px-4 py-4 rounded-2xl bg-white text-black font-black text-lg hover:opacity-95"
            data-i="0"></button>
          <button class="choice w-full px-4 py-4 rounded-2xl bg-white/10 border border-white/10 font-black text-lg hover:bg-white/15"
            data-i="1"></button>
          <button class="choice w-full px-4 py-4 rounded-2xl bg-white/10 border border-white/10 font-black text-lg hover:bg-white/15"
            data-i="2"></button>
        </div>

        <button id="skipBtn"
          class="mt-4 w-full py-3 rounded-2xl bg-black/30 border border-white/10 font-bold hover:bg-black/40">
          Skip (no points)
        </button>
      </div>

      <!-- End Screen -->
      <div id="endScreen" class="hidden text-center">
        <div class="text-3xl font-black tracking-tight">Round Complete üéüÔ∏è</div>
        <p class="text-white/75 mt-2">Here‚Äôs your Splash Report Card:</p>

        <div class="mt-4 grid grid-cols-3 gap-3">
          <div class="rounded-2xl bg-black/25 border border-white/10 p-3">
            <div class="text-xs text-white/60">Correct</div>
            <div class="text-2xl font-black tabular-nums" id="correctOut">0</div>
          </div>
          <div class="rounded-2xl bg-black/25 border border-white/10 p-3">
            <div class="text-xs text-white/60">Best Streak</div>
            <div class="text-2xl font-black tabular-nums" id="bestStreakOut">0</div>
          </div>
          <div class="rounded-2xl bg-black/25 border border-white/10 p-3">
            <div class="text-xs text-white/60">Score</div>
            <div class="text-2xl font-black tabular-nums" id="scoreOut">0</div>
          </div>
        </div>

        <button id="playAgainBtn"
          class="mt-5 w-full py-4 rounded-2xl bg-[#D81B60] hover:opacity-90 font-black text-lg shadow-lg">
          Play Again
        </button>

        <button id="shareBtn"
          class="mt-3 w-full py-3 rounded-2xl bg-white/10 hover:bg-white/15 border border-white/10 font-bold">
          Share Score
        </button>
      </div>
    </section>

    <p class="text-center text-xs text-white/50 mt-4">
      Wisconsin Dales: come for the jokes. stay cause you clicked.
    </p>
  </main>

  <!-- Sounds (put files in /punzone/) -->
  <audio id="sfxCorrect" src="/punzone/correct.wav" preload="auto"></audio>
  <audio id="sfxWrong" src="/punzone/wrong.wav" preload="auto"></audio>
  <audio id="sfxTick" src="/punzone/tick.wav" preload="auto"></audio>

  <script>
    // Service worker for the game
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("/punzone/sw.js");
    }

    // ----------------------------
    // Config
    // ----------------------------
    const LS = {
      high: "dales_quiz_high",
      sound: "dales_quiz_sound",
      diff: "dales_quiz_diff",        // "easy" | "deep"
      mode: "dales_quiz_mode"         // "round" | "daily"
    };

    const ROUND_TOTAL = 10;

    // Easy vs Deep (faster timer and slightly higher scoring)
    const DIFF = {
      easy: { label: "Easy", sub: "Chill groans", timeMs: 5200, base: 10, streakBonusStep: 3, streakBonusAmt: 2 },
      deep: { label: "Deep", sub: "Fast waves", timeMs: 4200, base: 12, streakBonusStep: 2, streakBonusAmt: 2 }
    };

    // ----------------------------
    // UI
    // ----------------------------
    const qTotalEl = document.getElementById("qTotal");
    const qNumEl = document.getElementById("qNum");
    const waveLabel = document.getElementById("waveLabel");
    const waveBar = document.getElementById("waveBar");
    const secondsEl = document.getElementById("seconds");

    const scoreEl = document.getElementById("score");
    const streakEl = document.getElementById("streak");
    const highEl = document.getElementById("high");

    const card = document.getElementById("card");
    const startScreen = document.getElementById("startScreen");
    const playScreen = document.getElementById("playScreen");
    const endScreen = document.getElementById("endScreen");

    const statusEl = document.getElementById("status");
    const questionEl = document.getElementById("question");
    const jokeBox = document.getElementById("jokeBox");

    const startBtn = document.getElementById("startBtn");
    const skipBtn = document.getElementById("skipBtn");
    const playAgainBtn = document.getElementById("playAgainBtn");
    const shareBtn = document.getElementById("shareBtn");

    const correctOut = document.getElementById("correctOut");
    const bestStreakOut = document.getElementById("bestStreakOut");
    const scoreOut = document.getElementById("scoreOut");

    const confetti = document.getElementById("confetti");
    const choiceButtons = Array.from(document.querySelectorAll(".choice"));

    const loadStatus = document.getElementById("loadStatus");
    const startDesc = document.getElementById("startDesc");

    const modeRoundBtn = document.getElementById("modeRound");
    const modeText = document.getElementById("modeText");
    const modeSub = document.getElementById("modeSub");

    const difficultyBtn = document.getElementById("difficultyBtn");
    const diffText = document.getElementById("diffText");
    const diffSub = document.getElementById("diffSub");

    const soundBtn = document.getElementById("soundBtn");
    const soundText = document.getElementById("soundText");
    const soundSub = document.getElementById("soundSub");

    // Sounds
    const sfxCorrect = document.getElementById("sfxCorrect");
    const sfxWrong = document.getElementById("sfxWrong");
    const sfxTick = document.getElementById("sfxTick");

    // ----------------------------
    // Data
    // jokes.json format:
    // {
    //   "easy": [ { "q": "...", "c": ["..","..",".."], "a": 0 }, ... ],
    //   "deep": [ ... ]   // optional; if missing, easy list is used
    // }
    // ----------------------------
    let JOKES_EASY = [];
    let JOKES_DEEP = [];

    async function loadJokes() {
      try {
        const res = await fetch("/punzone/jokes.json", { cache: "no-store" });
        if (!res.ok) throw new Error("Failed to load jokes.json");
        const data = await res.json();

        JOKES_EASY = Array.isArray(data.easy) ? data.easy : [];
        JOKES_DEEP = Array.isArray(data.deep) ? data.deep : [];

        // Fallback: if deep isn't provided, reuse easy
        if (JOKES_DEEP.length === 0) JOKES_DEEP = JOKES_EASY.slice();

        if (JOKES_EASY.length < ROUND_TOTAL) {
          loadStatus.textContent = `Loaded ${JOKES_EASY.length} jokes üò¨ (add more for best results)`;
        } else {
          loadStatus.textContent = `Loaded jokes ‚úÖ Ready to splash.`;
        }

        startBtn.disabled = false;
        startBtn.classList.remove("opacity-60");
      } catch (e) {
        loadStatus.textContent = "Could not load jokes.json üò¨ (check file name & location)";
        startBtn.disabled = true;
        startBtn.classList.add("opacity-60");
      }
    }

    // ----------------------------
    // Helpers
    // ----------------------------
    qTotalEl.textContent = ROUND_TOTAL;

    function burstConfetti(n = 14) {
      const w = window.innerWidth;
      const colors = ["#D81B60", "#FF79A9", "#FFC0CB", "#FFFFFF", "#F59E0B", "#22C55E", "#8B5CF6"];
      for (let i = 0; i < n; i++) {
        const s = document.createElement("span");
        s.style.left = `${Math.random() * w}px`;
        s.style.top = `${-30 - Math.random() * 60}px`;
        s.style.background = colors[Math.floor(Math.random() * colors.length)];
        s.style.animationDelay = `${Math.random() * 120}ms`;
        confetti.appendChild(s);
        setTimeout(() => s.remove(), 1200);
      }
    }

    function shuffle(arr) {
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    function setScreen(which) {
      startScreen.classList.add("hidden");
      playScreen.classList.add("hidden");
      endScreen.classList.add("hidden");
      which.classList.remove("hidden");
    }

    function setHUD() {
      scoreEl.textContent = String(score);
      streakEl.textContent = String(streak);
      qNumEl.textContent = String(Math.min(idx, ROUND_TOTAL));
    }

    function setWave(progress01) {
      const pct = Math.max(0, Math.min(1, progress01)) * 100;
      waveBar.style.width = pct + "%";
      waveBar.style.background = (pct < 35) ? "#ff6b6b" : "#D81B60";
    }

    function todayKey() {
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth() + 1).padStart(2, "0");
      const dd = String(d.getDate()).padStart(2, "0");
      return `${yyyy}-${mm}-${dd}`;
    }

    function seededIndex(seedStr, max) {
      let h = 2166136261;
      for (let i = 0; i < seedStr.length; i++) {
        h ^= seedStr.charCodeAt(i);
        h = Math.imul(h, 16777619);
      }
      return Math.abs(h) % max;
    }

    // ----------------------------
    // Settings (mode/difficulty/sound)
    // ----------------------------
    function getMode() {
      return localStorage.getItem(LS.mode) || "round"; // "round" | "daily"
    }
    function setMode(mode) {
      localStorage.setItem(LS.mode, mode);
      if (mode === "daily") {
        modeText.textContent = "Daily";
        modeSub.textContent = todayKey();
        waveLabel.textContent = "Today‚Äôs wave‚Ä¶";
        startDesc.textContent = "Daily challenge: same 10 jokes today. Beat your score.";
        startBtn.textContent = "Start Daily";
      } else {
        modeText.textContent = "Round";
        modeSub.textContent = "10 questions";
        waveLabel.textContent = "Wave incoming‚Ä¶";
        startDesc.textContent = "10 dad jokes. 3 choices. Beat the wave timer.";
        startBtn.textContent = "Start Round";
      }
    }

    function getDiffKey() {
      return localStorage.getItem(LS.diff) || "easy";
    }
    function setDifficulty(key) {
      const cfg = DIFF[key] || DIFF.easy;
      localStorage.setItem(LS.diff, key);
      diffText.textContent = cfg.label;
      diffSub.textContent = cfg.sub;
    }

    function getSoundOn() {
      const v = localStorage.getItem(LS.sound);
      return v === null ? true : (v === "1");
    }
    function setSoundOn(on) {
      localStorage.setItem(LS.sound, on ? "1" : "0");
      soundText.textContent = on ? "On" : "Off";
      soundSub.textContent = on ? "Splash FX" : "Silent";
    }

    function playSfx(el) {
      if (!getSoundOn()) return;
      try {
        el.currentTime = 0;
        el.play();
      } catch { /* ignore */ }
    }

    // ----------------------------
    // Game state
    // ----------------------------
    let order = [];
    let idx = 0;
    let timer = null;
    let startTime = 0;

    let score = 0;
    let streak = 0;
    let bestStreak = 0;
    let correct = 0;

    let activeAnswer = 0;
    let accepting = false;

    function loadHigh() {
      const v = Number(localStorage.getItem(LS.high) || 0);
      highEl.textContent = String(v);
      return v;
    }

    function saveHighIfNeeded() {
      const currentHigh = Number(localStorage.getItem(LS.high) || 0);
      if (score > currentHigh) {
        localStorage.setItem(LS.high, String(score));
        highEl.textContent = String(score);
        burstConfetti(22);
      }
    }

    function stopTimer() {
      if (timer) cancelAnimationFrame(timer);
      timer = null;
    }

    function startTimer(questionTimeMs) {
      stopTimer();
      startTime = performance.now();

      const tick = (now) => {
        const elapsed = now - startTime;
        const remaining = Math.max(0, questionTimeMs - elapsed);
        const sec = (remaining / 1000).toFixed(1);
        secondsEl.textContent = sec + "s";
        setWave(remaining / questionTimeMs);

        // tick sound when < 1.5s remaining (subtle)
        if (remaining < 1500 && remaining > 1400) playSfx(sfxTick);
        if (remaining < 1000 && remaining > 900) playSfx(sfxTick);
        if (remaining < 500 && remaining > 400) playSfx(sfxTick);

        if (remaining <= 0) {
          accepting = false;
          onTimeout();
          return;
        }
        timer = requestAnimationFrame(tick);
      };

      timer = requestAnimationFrame(tick);
    }

    function setChoicesEnabled(enabled) {
      choiceButtons.forEach((b) => {
        b.disabled = !enabled;
        b.classList.toggle("opacity-60", !enabled);
      });
      skipBtn.disabled = !enabled;
      skipBtn.classList.toggle("opacity-60", !enabled);
    }

    function currentJokesList() {
      const diffKey = getDiffKey();
      return diffKey === "deep" ? JOKES_DEEP : JOKES_EASY;
    }

    function dailyOrder(listLength) {
      // Make a deterministic set of 10 indices for today
      const seed = todayKey() + "|" + getDiffKey();
      const used = new Set();
      const result = [];
      let counter = 0;

      while (result.length < Math.min(ROUND_TOTAL, listLength) && counter < 5000) {
        const idx = seededIndex(seed + "|" + counter, listLength);
        if (!used.has(idx)) {
          used.add(idx);
          result.push(idx);
        }
        counter++;
      }

      // If list is small, fill by cycling
      while (result.length < Math.min(ROUND_TOTAL, listLength)) {
        result.push(result.length % listLength);
      }
      return result;
    }

    function renderQuestion() {
      accepting = true;
      setChoicesEnabled(true);

      const list = currentJokesList();
      const joke = list[order[idx]];
      if (!joke) {
        // Safety fallback if list is too short
        endRound();
        return;
      }

      activeAnswer = Number(joke.a) || 0;

      statusEl.textContent = "Pick the right punchline.";
      questionEl.textContent = joke.q || "‚Ä¶";

      // Fill buttons
      choiceButtons.forEach((btn, i) => {
        btn.textContent = (joke.c && joke.c[i]) ? joke.c[i] : "‚Äî";
        btn.classList.remove("bg-green-500", "bg-red-500", "text-white");
        if (i === 0) {
          btn.classList.add("bg-white");
          btn.classList.remove("bg-white/10", "border", "border-white/10");
          btn.classList.add("text-black");
        } else {
          btn.classList.remove("bg-white");
          btn.classList.add("bg-white/10", "border", "border-white/10");
          btn.classList.remove("text-black");
          btn.classList.add("text-white");
        }
      });

      card.classList.remove("pop");
      void card.offsetWidth;
      card.classList.add("pop");

      const cfg = DIFF[getDiffKey()] || DIFF.easy;
      startTimer(cfg.timeMs);
      setHUD();
    }

    function scoreForCorrect() {
      const cfg = DIFF[getDiffKey()] || DIFF.easy;
      const bonus = Math.floor(streak / cfg.streakBonusStep) * cfg.streakBonusAmt;
      return cfg.base + bonus;
    }

    function showCorrect(btn) {
      btn.classList.remove("bg-white", "bg-white/10", "border-white/10", "text-black", "text-white");
      btn.classList.add("bg-green-500", "text-white");
      burstConfetti(10);
    }

    function showWrong(btn) {
      btn.classList.remove("bg-white", "bg-white/10", "border-white/10", "text-black", "text-white");
      btn.classList.add("bg-red-500", "text-white");

      jokeBox.classList.remove("shake");
      void jokeBox.offsetWidth;
      jokeBox.classList.add("shake");
    }

    function lockAndAdvance(delay = 650) {
      accepting = false;
      setChoicesEnabled(false);
      stopTimer();

      setTimeout(() => {
        idx += 1;
        if (idx >= ROUND_TOTAL) endRound();
        else renderQuestion();
      }, delay);
    }

    function onTimeout() {
      statusEl.textContent = "üåä Too slow! The wave got you.";
      streak = 0;
      setHUD();
      playSfx(sfxWrong);
      lockAndAdvance(700);
    }

    function handleChoice(i) {
      if (!accepting) return;

      const btn = choiceButtons[i];

      if (i === activeAnswer) {
        correct += 1;
        streak += 1;
        bestStreak = Math.max(bestStreak, streak);

        const gained = scoreForCorrect();
        score += gained;

        statusEl.textContent = `üí¶ SPLASH! +${gained}`;
        showCorrect(btn);
        playSfx(sfxCorrect);
      } else {
        statusEl.textContent = "üôÑ Wrong! Dad disapproves.";
        streak = 0;
        showWrong(btn);
        playSfx(sfxWrong);

        const correctBtn = choiceButtons[activeAnswer];
        showCorrect(correctBtn);
      }

      setHUD();
      lockAndAdvance(750);
    }

    function startRound() {
      const list = currentJokesList();

      if (!list || list.length === 0) {
        loadStatus.textContent = "No jokes loaded üò¨ Check jokes.json";
        return;
      }

      score = 0;
      streak = 0;
      bestStreak = 0;
      correct = 0;

      const mode = getMode();
      idx = 0;

      if (mode === "daily") {
        // deterministic
        order = dailyOrder(list.length);
      } else {
        // random 10 unique if possible
        const all = shuffle([...Array(list.length).keys()]);
        order = all.slice(0, Math.min(ROUND_TOTAL, all.length));
        // if fewer than 10 jokes, loop them
        while (order.length < ROUND_TOTAL) order.push(order[order.length % all.length]);
      }

      setScreen(playScreen);
      setHUD();
      renderQuestion();
    }

    function endRound() {
      stopTimer();
      accepting = false;

      saveHighIfNeeded();

      correctOut.textContent = `${correct}/${ROUND_TOTAL}`;
      bestStreakOut.textContent = String(bestStreak);
      scoreOut.textContent = String(score);

      setScreen(endScreen);
    }

    async function shareScore() {
      const mode = getMode();
      const diff = getDiffKey();
      const tag = mode === "daily" ? `Daily ${todayKey()}` : "Round";
      const text = `Wisconsin Dales: Splash Quiz üí¶\nMode: ${tag}\nDifficulty: ${diff.toUpperCase()}\nScore: ${score}\nCorrect: ${correct}/${ROUND_TOTAL}\nBest Streak: ${bestStreak}\nPlay: https://www.wisconsindales.com/punzone/`;
      try {
        if (navigator.share) {
          await navigator.share({ title: "Splash Quiz", text });
        } else {
          await navigator.clipboard.writeText(text);
          statusEl.textContent = "Copied score ‚úÖ";
        }
      } catch { /* ignore */ }
    }

    // ----------------------------
    // Events
    // ----------------------------
    startBtn.addEventListener("click", startRound);
    playAgainBtn.addEventListener("click", startRound);
    shareBtn.addEventListener("click", shareScore);

    skipBtn.addEventListener("click", () => {
      if (!accepting) return;
      statusEl.textContent = "Skipped.";
      streak = 0;
      setHUD();
      lockAndAdvance(500);
    });

    choiceButtons.forEach((btn) => {
      btn.addEventListener("click", () => {
        const i = Number(btn.dataset.i);
        handleChoice(i);
      });
    });

    modeRoundBtn.addEventListener("click", () => {
      const next = (getMode() === "round") ? "daily" : "round";
      setMode(next);
    });

    difficultyBtn.addEventListener("click", () => {
      const next = (getDiffKey() === "easy") ? "deep" : "easy";
      setDifficulty(next);
    });

    soundBtn.addEventListener("click", () => {
      setSoundOn(!getSoundOn());
      // tiny confirmation
      if (getSoundOn()) playSfx(sfxCorrect);
    });

    // ----------------------------
    // Init
    // ----------------------------
    (async function init() {
      // disable start until jokes load
      startBtn.disabled = true;
      startBtn.classList.add("opacity-60");

      loadHigh();
      setSoundOn(getSoundOn());
      setDifficulty(getDiffKey());
      setMode(getMode());

      setScreen(startScreen);
      setWave(1);
      secondsEl.textContent = "5.0s";

      await loadJokes();
    })();
  </script>
</body>
</html>
